<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webchat</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b0d10; color:#e8eaed }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 14px; }
    .card { background:#12161a; border:1px solid #21262d; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .chat { display:flex; flex-direction:column; gap:10px; height:60vh; overflow:auto; padding:6px; border:1px solid #2b3138; border-radius:12px; background:#0e1116 }
    .msg { max-width: 80%; padding:10px 12px; border-radius:12px; line-height:1.45; white-space:pre-wrap }
    .you { align-self:flex-end; background:#1f2937; border:1px solid #2b3138 }
    .bot { align-self:flex-start; background:#0b1320; border:1px solid #1e293b }
    .bar { display:flex; gap:10px; margin-top:12px }
    textarea, input, button { font:inherit; color:#e8eaed; background:#0e1116; border:1px solid #2b3138; border-radius:10px; }
    textarea { width:100%; min-height:80px; padding:10px; resize:vertical }
    .side { width: 260px; display:flex; flex-direction:column; gap:10px }
    .field { display:flex; flex-direction:column; gap:6px }
    .pill { font-size:12px; color:#aeb4ba }
    button { padding:10px 14px; background:#2563eb; border:none; cursor:pointer }
    button:disabled { opacity:.6; cursor:not-allowed }
    .muted { color:#9aa2a9; font-size:12px }
    .row { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 920px) { .row { grid-template-columns: 1fr 260px; } }
    .spinner { width:14px; height:14px; border:2px solid #94a3b8; border-top-color:transparent; border-radius:50%; display:inline-block; animation:spin .8s linear infinite; vertical-align:text-bottom }
    @keyframes spin { to { transform: rotate(360deg) } }
    .error { color:#ff7b7b; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Webchat</h2>

      <div class="row">
        <div>
          <div id="chat" class="chat"></div>
          <div class="bar">
            <textarea id="input" placeholder="Say something…"></textarea>
          </div>
          <div class="bar" style="justify-content:space-between; align-items:center">
            <div class="muted">History is stored per-browser using a local <code>client_id</code>.</div>
            <div>
              <button id="send">Send</button>
              <button id="clear" style="background:#1f2937; border:1px solid #2b3138">Clear</button>
            </div>
          </div>
          <div id="error" class="error"></div>
        </div>

        <div class="side">
          <div class="field">
            <label>Temperature <span id="tVal" class="pill">0.7</span></label>
            <input id="temp" type="range" min="0" max="2" step="0.01" value="0.7">
          </div>
          <div class="field">
            <label>Max new tokens</label>
            <input id="max" type="number" min="1" max="4096" step="1" value="100">
          </div>
          <div class="field">
            <label>Repetition penalty</label>
            <input id="rep" type="number" min="0.8" max="2.5" step="0.01" value="1.15">
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const errorEl = document.getElementById('error');
    const ta = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const temp = document.getElementById('temp');
    const tVal = document.getElementById('tVal');
    const maxTok = document.getElementById('max');
    const rep = document.getElementById('rep');

		function getClientId() {
			let id = localStorage.getItem('client_id');
			if (!id) {
				if (crypto && crypto.randomUUID) {
					id = crypto.randomUUID();
				} else {
					// Simple non-crypto fallback (less secure, but works without HTTPS)
					id = 'xxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
						const r = Math.random() * 16 | 0;
						const v = c === 'x' ? r : (r & 0x3 | 0x8);
						return v.toString(16);
					});
				}
				localStorage.setItem('client_id', id);
			}
			return id;
		}

    function addMsg(text, who) {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    temp.addEventListener('input', () => tVal.textContent = temp.value);
    ta.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
				// if Shift+Enter, just add a newline
				if (e.shiftKey) {
					ta.value += '\n';
					e.preventDefault();
				} else {
        	e.preventDefault(); send();
				}
      }
    });
    sendBtn.addEventListener('click', send);
		clearBtn.addEventListener('click', () => { 
				chat.innerHTML = ''; 
				errorEl.textContent = ''; 

				fetch(`/webchat/clear?client_id=${encodeURIComponent(getClientId())}`, {
						method: 'POST'
				});
		});

    async function send() {
      const msg = ta.value.trim();
      if (!msg) return;
      errorEl.textContent = '';
      addMsg(msg, 'you');
      ta.value = '';
      const payload = {
        client_id: getClientId(),
        message: msg,
        temperature: Number(temp.value),
        max_new_tokens: Number(maxTok.value),
        repetition_penalty: Number(rep.value)
      };
      sendBtn.disabled = true;
      const original = sendBtn.textContent;
      sendBtn.innerHTML = '<span class="spinner"></span> Loading…';
      try {
        const res = await fetch('/webchat/send', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || `HTTP ${res.status}`);
        }
        const data = await res.json();
        addMsg(data.reply || '(empty)', 'bot');
      } catch (e) {
        errorEl.textContent = e.message || String(e);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = original;
      }
    }
  </script>
</body>
</html>
